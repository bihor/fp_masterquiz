<html xmlns:f="https://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers" data-namespace-typo3-fluid="true">
	<f:layout name="Default" />
 
	<f:section name="content">
		<f:flashMessages />
		<f:form.validationResults>
		  <f:if condition="{validationResults.flattenedErrors}">
		    <ul class="errors">
		      <f:for each="{validationResults.flattenedErrors}" as="errors" key="propertyPath">
		        <li>{propertyPath}
		          <ul>
		          <f:for each="{errors}" as="error">
		            <li>{error.code}: {error}</li>
		          </f:for>
		          </ul>
		        </li>
		      </f:for>
		    </ul>
		  </f:if>
		</f:form.validationResults>
		<f:if condition="{settings.templateLayout} == 1">
			<!-- charts-layout -->
			<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
			<script>
				var charttype = '{settings.chart.type}';
				var chartwidth = parseInt({settings.chart.width});
			</script>
		</f:if>
		
		{settings.template.wrapQuizTitle1 -> f:format.raw()}{quiz.name}{settings.template.wrapQuizTitle2 -> f:format.raw()}
		<f:if condition="{quiz.about}">{settings.template.wrapQuizDesc1 -> f:format.raw()}{quiz.about}{settings.template.wrapQuizDesc2 -> f:format.raw()}</f:if>
		
		<f:if condition="{settings.ajax} == 1">
		<f:then>
			<f:comment> This part is used only, if AJAX is enabled! </f:comment>
			<f:form id="quiz-form{uidOfCE}" method="POST" noCacheHash="1" argumentsToBeExcludedFromQueryString="{0: 'cHash'}">
				<input type="hidden" name="type" value="{settings.typeNum}">
	            <input type="hidden" name="L" value="{sysLanguageUid}">
	            <input type="hidden" name="id" value="{uidOfPage}">
				<f:form.hidden name="action" value="showAjax" />
				<f:form.hidden name="quiz" value="{quiz.uid}" />
				<f:form.hidden name="uidOfCE" value="{uidOfCE}" />
				<f:form.hidden name="participant" value="0" id="quiz-form-parti" />
				<f:form.hidden name="currentPage" value="1" id="quiz-form-page" />
				<f:form.hidden name="showAnswers" value="0" id="quiz-form-answers" />
				<f:form.hidden name="useJoker" value="0" id="quiz-form-joker" />
	            <!--  f:form.hidden name="session" value="{session}" / -->
	            
	            <script>
					var ceuid = '{uidOfCE}';
					var quizanswers = 0;
					var quizfinal = 0;
					var thisPage = {page};
					var maxPages = {pages};
					var showQuizAnswers = '{settings.showAnswerPage}';
		            var text_goon = '{f:translate(key: "text.goon")}';
		            var text_gofinal = '{f:translate(key: "text.gofinal")}';
		            var text_errorEmpty = '{f:translate(key: "text.errorEmpty")}';
				</script>
				
				<div id="quiz-ajaxCallResult"></div>
				
				<f:if condition="{settings.user.askForData}">
					<f:render partial="Participant/Form" arguments="{_all}" />
				</f:if>
								
				<div id="quiz-button-wrap">
					<div class="pull-right quiz-subm">
						<f:form.submit value="{f:translate(key: 'text.goon')}" class="btn btn-primary btn-lg" name="quizGoOn" id="quiz-GoOn" />
					</div>
				</div>
				
				<script>
					<f:render partial="Quiz/CheckForm" arguments="{uidOfCE: uidOfCE}" />
					
			        jQuery(document).ready(function ($) {
			            var form = $('#quiz-form'+ceuid);
			            var resultContainer = $('#quiz-ajaxCallResult');
			            var service = {
			                ajaxCall: function (data) {
			                    $.ajax({
			                        url: '/index.php',
			                        cache: false,
			                        type: 'POST',
			                        data: data.serialize(),
			                        success: function (result) {
			                        	// display the AJAX-result and set the JS-variable quizfinal
			                            resultContainer.html(result).show();
			                            <f:render partial="Quiz/CheckFields" arguments="{uidOfCE: uidOfCE}" />
				                       	var thisQuizPage = $('#quiz-form-page').val();
				                       	if ($('#quiz-userData').length) {
					                       	if ((thisQuizPage > 1) || (quizanswers == 1)) {
					                       		$('#quiz-userData').hide();
					                       	} else {
					                       		if ($('#quiz-user-name').length) $('#quiz-user-name').val('');
					                       		if ($('#quiz-user-email').length) $('#quiz-user-email').val('');
					                       		if ($('#quiz-user-homepage').length) $('#quiz-user-homepage').val('');
					                       		$('#quiz-userData').show();
					                       	}
				                        }
			                            if (thisQuizPage > maxPages) {
			                            	if (showQuizAnswers == '0' || quizanswers == 1) {
				                            	$('#quiz-GoOn').val(text_gofinal);
			                            	}
			                            	if (quizfinal == 1) {
			                            		$('#quiz-button-wrap').hide();
			                            	}
			                            }
			                        },
			                        error: function (jqXHR, textStatus, errorThrow) {
			                            resultContainer.html('Ajax request - ' + textStatus + ': ' + errorThrow + ' ('+data.serialize()+')').fadeIn('fast');
			                        }
			                    });
			                }
			            };
			            form.submit(function (ev) {
			                ev.preventDefault();
			                var allSelected = checkQuizForm();
							if (allSelected || ($('#quiz-form'+ceuid+' #quiz-form-joker').val() == '1')) {
								service.ajaxCall($(this));
							} else {
								window.alert(text_errorEmpty);
							}
			            });
			            service.ajaxCall(form);
			        });
					function getQuizJoker() {
						$('#quiz-form'+ceuid+' #quiz-form-page').val(thisPage);
						$('#quiz-form'+ceuid+' #quiz-form-answers').val('0');
						$('#quiz-form'+ceuid+' #quiz-form-joker').val('1');
						$('#quiz-form'+ceuid).submit();
					}
			    </script>
		    </f:form>
		</f:then>
		<f:else>
			<f:comment> This part is used in normal case! </f:comment>
			<f:form action="show" id="quiz-form{uidOfCE}" method="POST">
				<f:form.hidden name="quiz" value="{quiz.uid}" />
				<f:form.hidden name="participant" value="{participant.uid}" />
				<f:form.hidden name="@widget_0[currentPage]" value="{nextPage}" />
				<f:form.hidden name="showAnswers" value="{showAnswersNext}" />
				<f:form.hidden name="session" value="{session}" />
				
				<f:if condition="{final} == 0">
					<f:then>
					
						<f:if condition="({settings.showPageNo} == 1) && ({pages} != 1)">
							<p class="quiz-progress">{f:translate(key: "text.page")} <span>{page}</span> {f:translate(key: "text.of")} {pages} ({pagePercent}%)</p>
						</f:if>
						
						<f:if condition="{showAnswers}">
							<f:then>
							
								<!--  show answers after submit -->
								<f:widget.paginate objects="{participant.selections}" as="paginatedSelections" configuration="{settings.pagebrowser}">
									<f:for each="{paginatedSelections}" as="selection" iteration="pageiterator">
										<f:render partial="Question/PropertiesSent" arguments="{_all}" />
									</f:for>
								</f:widget.paginate>
								
								<f:if condition="{settings.showPoints}">
									<f:comment> {participant -> f:debug(title: 'Members of participant')} </f:comment> 
									<p>{f:translate(key: "text.pointsYet")} {participant.points}/{participant.maximum1}.</p>
								</f:if>
				
								<div>
									<div class="pull-right quiz-subm">
										<f:form.button type="submit" name="quizGoOn" class="btn btn-primary btn-lg">
											<f:if condition="{pages} == {page}">
											<f:then>
												{f:translate(key: "text.gofinal")}
											</f:then>
											<f:else>
												{f:translate(key: "text.goon")}
											</f:else>
											</f:if>
										</f:form.button>
									</div>
								</div>
								
							</f:then>
							<f:else>
						
								<!-- show questions -->
								<f:widget.paginate objects="{quiz.questions}" as="paginatedQuestions" configuration="{settings.pagebrowser}">
									<f:for each="{paginatedQuestions}" as="question" iteration="pageiterator">
										<f:render partial="Question/Properties" arguments="{_all}" />
									</f:for>
								</f:widget.paginate>
								
								<f:if condition="{settings.user.askForData}">
									<f:if condition="{page} == 1">
										<f:render partial="Participant/Form" arguments="{_all}" />
									</f:if>
								</f:if>
								
								<div>
									<div class="pull-right quiz-subm">
										<f:form.button type="button" name="quizGoOn" id="quiz-GoOn" class="btn btn-primary btn-lg">
											<f:if condition="{pages} == {page}">
											<f:then>
												<f:if condition="{settings.showAnswerPage} == 1"><f:then>
													{f:translate(key: "text.goon")}
												</f:then><f:else>
													{f:translate(key: "text.gofinal")}
												</f:else></f:if>
											</f:then>
											<f:else>
												{f:translate(key: "text.goon")}
											</f:else>
											</f:if>
										</f:form.button>
									</div>
								</div>
						
								<script>
									var ceuid = '{uidOfCE}';
									var quizfinal = 0;
						            var text_errorEmpty = '{f:translate(key: "text.errorEmpty")}';
									<f:render partial="Quiz/CheckForm" arguments="{uidOfCE: uidOfCE}" />
									<f:render partial="Quiz/CheckFields" arguments="{uidOfCE: uidOfCE}" />
									
									$( "#quiz-GoOn" ).click(function() {
										// check if there are selected answers to all questions. if not, show an warning
										var allSelected = checkQuizForm();
										if (allSelected) {
											$('#quiz-form'+ceuid).submit();
										} else {
											window.alert(text_errorEmpty);
										}
									});
								</script>
							</f:else>
						</f:if>
						
					</f:then>
					<f:else>
					
						<f:render partial="Quiz/FinalPage" arguments="{_all}" />
						
					</f:else>
				</f:if>
			</f:form>
		</f:else>
		</f:if>
		<f:if condition="{settings.debug}">
			<pre>{debug}</pre>
		</f:if>
	</f:section>
	<f:comment>
	f:if(condition: '{pages} == {page}', then: 'Zur Auswertung', else: 'weiter')
	</f:comment>
</html>